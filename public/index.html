<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8" />
  <title>Co-Storming-Space</title>
  <meta name="description" content="Co-Storming-Space" />
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://unpkg.com/networked-aframe@^0.8.0/dist/networked-aframe.min.js"></script>
  <script src="https://morandd.github.io/aframe-multitouch-look-controls/multitouch-look-controls.js"></script>
  <!-- <script src="https://unpkg.com/aframe-randomizer-components@^3.0.1/dist/aframe-randomizer-components.min.js"></script> -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.slim.js"></script>
  <script src="/easyrtc/easyrtc.js"></script>

  <script> window.AFK || document.write('<script src="/ui/aframe-keyboard.min.js">\x3C/script>')</script>

  <script src="/js/delete.js"></script>
  <script src="/js/addpostit.js"></script>
  <script src="/js/movepostit.js"></script>
  <script src="/js/submitinfo.js"></script>
  <script src="/js/selectcolor.js"></script>
</head>



<body>
  <a-scene detectpostits id="scene" networked-scene="room: basic; debug: true;" keyboard-shortcuts="enterVR: false">
    <a-assets>
      <img id="delete-icon" src="/assets/delete.svg">
      <img id="grid" src="https://img.gs/bbdkhfbzkk/stretch/https://i.imgur.com/25P1geh.png" crossorigin="anonymous">
      <img id="sky" src="https://img.gs/bbdkhfbzkk/2048x2048,stretch/https://i.imgur.com/WqlqEkq.jpg"
        crossorigin="anonymous" />
      <img id="groundTexture" src="/assets/ground.jpg">


      <!-- Templates -->
      <!-- Post It -->
      <template id="post-it-template">
        <a-entity movepostit="Kago" class="post-it clickable" material="color: #ca9" geometry="primitive:box"
          scale="1 1 0.00002">
          <a-entity id="nameTag" scale="0.5 0.14 0.1" material="color: #c78" geometry="primitive: plane;"
            position="-0.2 0.39 1000">
            <a-entity id="name" scale="1.4 4.5 2" position="2.4 0 1000" text="value: Marion; color:black;width: 4;">
            </a-entity>
          </a-entity>
          <a-entity delete="" geometry="primitive: plane" class="delete-icon clickable" material="src:#delete-icon"
            scale="0.12 0.12 0" position="0.39 0.4 100">

            <a-entity
              speech-command="command: delete; type: function; function: voiceDelete; targetElement: #cursor; targetComponent: teleporter; function: teleport; keyCode: 13">
            </a-entity>
          </a-entity>
        </a-entity>
      </template>
    </a-assets>

    <!-- Welcome Screen -->
    <a-entity id="welcome-screen" geometry="primitive: plane" position=" 0 6 -4.1" scale=" 0.2 0.14 0.4"
      material="color: black">
      <a-text color="#ca9" position="0 0.35 0.02" width="3" scale=" 0.3 0.3 0.1" baseline="center" align="center"
        anchor="center" value="Co-Storming Space"></a-text>
      <a-text color="#ca9" position="0 0.25 0.02" width="2" scale=" 0.3 0.3 0.1" baseline="center" align="center"
        anchor="center" value="Hey, wie heisst du?"></a-text>
      <a-text id="name-input" position="0 0.19 0.02" width="3" scale=" 0.3 0.3 0.1" baseline="center" align="center"
        anchor="center" value="This is where the name will be typed"></a-text>
      <!-- TODO: this one should appear with personalized Text once keyboard input has been submitted -->
      <a-text color="#ca9" position="0 0.05 0.02" width="2" scale=" 0.3 0.3 0.1" baseline="center" align="center"
        anchor="center" value="Wilkommen, XY! \n \n  Waehle deine Farbe, \n und dann geht es auch schon los!"></a-text>

      <!-- The colors the user can choose from for the name tag: should also appear on submit of name -->
      <a-entity selectcolor="color: #58f" id="color-input-blue" class="color-btn clickable" geometry="primitive: plane"
        position="-0.3 -0.15 0.02" scale=" 0.1 0.13 0.1" material="color: white"
        text="baseline:center; align:center; anchor: center; width:4; value: Blau; color:black">
      </a-entity>

      <a-entity selectcolor="color: #6b7" id="color-input-green" class="color-btn clickable" geometry="primitive: plane"
        position="-0.15 -0.15 0.02" scale=" 0.1 0.13 0.1" material="color: white"
        text="baseline:center; align:center; anchor: center; width:4; value: Gruen; color:black">
      </a-entity>

      <a-entity selectcolor="color: #f6b" id="color-input-pink" class="color-btn clickable" geometry="primitive: plane"
        position="0 -0.15 0.02" scale=" 0.1 0.13 0.1" material="color: white"
        text="baseline:center; align:center; anchor: center; width:4; value: Rosa; color:black">
      </a-entity>

      <a-entity selectcolor="color: #c84" id="color-input-orange" class="color-btn clickable"
        geometry="primitive: plane" position="0.15 -0.15 0.02" scale=" 0.1 0.13 0.1" material="color: white"
        text="baseline:center; align:center; anchor: center; width:4; value: Orange; color:black">
      </a-entity>

      <a-entity selectcolor="color: #e45" id="color-input-red" class="color-btn clickable" geometry="primitive: plane"
        position="0.3 -0.15 0.02" scale=" 0.1 0.13 0.1" material="color: white"
        text="baseline:center; align:center; anchor: center; width:4; value: Rot; color:black">
      </a-entity>

      <a-entity visible="false" submitinfo="" id="welcome-submit" class="" geometry="primitive: plane"
        position="0 -0.35 0.02" scale=" 0.1 0.1 0.1" material="color: white"
        text="baseline:center; align:center; anchor: center; width:4; value: Fertig; color:black">
      </a-entity>
    </a-entity>

    <a-entity addpostit="userName: Kago; color: #000" id="wall" geometry="primitive: box" position=" 0 6 -10"
      scale=" 20 12 0.001" material="color: gray"></a-entity>
    <a-entity id="wallLeft" geometry="primitive: box" rotation="0 90 0" position=" -10 6 0" scale=" 20 12 0.001"
      material="color: gray"></a-entity>
    <a-entity addpostit="" id="wallRight" rotation="0 90 0" geometry="primitive: box" position=" 10 6 0"
      scale=" 20 12 0.001" material="color: gray"></a-entity>
    <a-entity id="wallBack" geometry="primitive: box" position=" 0 6 9" scale=" 20 12 0.001" material="color: gray">
    </a-entity>

    <a-entity id="player" multitouch-look-controls camera position="0 6 -4">
      <a-entity id="cursor" cursor="rayOrigin: mouse" raycaster="far: 250; objects: .clickable;" position="0 0 -1"
        geometry="primitive: ring; radiusInner: 0.04; radiusOuter: 0.05" material="color: black; shader: flat"
        animation__click="property: scale; startEvents: click; easing: easeInCubic; dur: 150; from: 0.1 0.1 0.1; to: 1 1 1">
      </a-entity>
    </a-entity>

    <a-entity id="annyang" annyang-speech-recognition></a-entity>
    <a-entity position="0 0 0" geometry="primitive: plane; width: 10000; height: 10000;" rotation="-90 0 0"
      material="src: #grid; repeat: 10000 10000; transparent: true; metalness:0.6; roughness: 0.4; sphericalEnvMap: #sky;">
    </a-entity>>

    <a-entity light="color: #f5eddf; intensity: 1; type: ambient;" visible=""></a-entity>
    <a-entity light="color: #f2eee9; intensity: 0.5;" position="0 0 5"></a-entity>

    <a-plane src="#groundTexture" id="floor" rotation="-90 0 0" width="30" height="30" repeat="2 2"></a-plane>




    <!-- KEYBOARD -->

    <!-- <a-entity>
      <a-text id="input" font="roboto" color="#000" value="Please insert your text..." scale="5 5 5" position="-6 8 -2">
      </a-text>
    </a-entity>  -->
    <!-- Keyboard -->
    <!-- <a-entity a-keyboard id="keyboard" position="-2 5 -5" scale="7 7 7"></a-entity> -->
    <!-- Mouse input -->
    <!-- <a-entity id="mouseCursor" raycaster="objects: .collidable" cursor="rayOrigin: mouse"></a-entity> -->
    <script>
      var input = ''
      function updateInput(e) {
        var code = parseInt(e.detail.code)
        switch (code) {
          case 8:
            input = input.slice(0, -1)
            break
          case 06:
            alert('submitted')
            var keyboard = document.querySelector('#keyboard')
            document.querySelector('#input').setAttribute('value', input)
            document.querySelector('#input').setAttribute('color', 'blue')
            keyboard.parentNode.removeChild(keyboard)
            return
          default:
            input = input + e.detail.value
            break
        }
        document.querySelector('#input').setAttribute('value', input + '_')
      }
      document.addEventListener('a-keyboard-update', updateInput)
    </script>


    <script>
      // Add web speech api 
      window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

      const wall = document.getElementById("wall");

      // setup SpeechRecognation
      const recognition = new SpeechRecognition();
      recognition.interimResults = true;
      recognition.lang = 'de-DE';

      // waiting for speech results
      recognition.addEventListener('result', event => {
        const transcript = event.results[0][0].transcript;
        // check if the voice input has ended
        if (event.results[0].isFinal) {

          // check if the input starts with 'create'
          if (transcript.indexOf('neu') == 0) {
            if (!document.getElementById("wall").is("neu")) {
              document.getElementById("wall").addState("neu");
            }

            // check if the input starts with 'delete'
          } else if (transcript.indexOf('löschen') == 0) {
            if (!document.getElementById("wall").is("löschen")) {
              document.getElementById("wall").addState("löschen");
            }

          } else if (transcript.indexOf('nimm') == 0) {
            if (!document.getElementById("wall").is("selected")) {
              console.log("selected")
              document.getElementById("wall").addState("selected");
            }
          }

        } else if (transcript.indexOf('passt') == 0 || transcript.indexOf('hast') == 0) {
          if (!document.getElementById("wall").is("deselected")) {
            document.getElementById("wall").addState("deselected");
          }
        }
        // Welcome Screen Interaction
        if (document.getElementById("welcome-screen") !== undefined) {
          if (transcript.indexOf('fertig') == 0 && !document.getElementById("welcome-screen").is("fertig")) {
            document.getElementById("wall").addState("fertig");
          }
        }

      });

      recognition.addEventListener('end', recognition.start);
      recognition.start();


      // Make cursor invisible for desktop 
      var isMobile = AFRAME.utils.device.isMobile();
      if (!isMobile) {
        // make cursor invisible for non-mobile
        document.getElementById("cursor").setAttribute("material", "opacity", "0.0");
        document.getElementById("cursor").setAttribute("material", "transparency", "true");
        document.getElementById("cursor").setAttribute("cursor", "rayOrigin", "mouse"); // set to entity
      }
    // Define custom schema for syncing avatar color, set by random-color
    // NAF.schemas.add({
    //   template: '#avatar-template',
    //   components: [
    //     'position',
    //     'rotation',
    //     {
    //       selector: '.head',
    //       component: 'material',
    //       property: 'color'
    //     }
    //   ]
    // });
    </script>
  </a-scene>
</body>

</html>